version: '3.8'

services:
  hapi-hub:
    build: .
    container_name: hapi-hub-test
    restart: always
    # 开启 TTY 方便查看实时日志
    tty: true
    environment:
      # ⚠️ 注意：Token 必须加引号，防止特殊字符被 Shell 解析错误
      - CLI_API_TOKEN='-NqHvSlaT_7taJwmUOmn4Q57YJQnVdOZ-n4KDVhUjLY'
      - HAPI_LISTEN_HOST=0.0.0.0
      - HAPI_LISTEN_PORT=3006
      - HAPI_PUBLIC_URL=https://hapi.384921.xyz
      - HAPI_HOME=/data
    ports:
      # 左边是宿主机端口 8443 (配合你之前的反代)，右边是容器端口 3006
      - "8443:3006"
    volumes:
      # 映射数据目录
      - ./data:/data
    # 动态启动脚本
    command: >
      sh -c "
        echo '>>> 1. Checking source code...' &&
        if [ ! -d '/app/.git' ]; then
          echo '>>> Cloning repository...' &&
          git clone https://github.com/tiann/hapi.git /app;
        else
          echo '>>> Updating repository...' &&
          cd /app && git pull;
        fi &&
        
        echo '>>> 2. Installing dependencies...' &&
        cd /app &&
        bun install &&
        
        echo '>>> 3. Starting HAPI Hub...' &&
        # 修正启动命令：使用 cli 入口启动 hub 模式
        bun run cli/src/index.ts hub
      "